<!DOCTYPE html>
<html lang="tg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { 
            margin: 0; padding: 0; 
            font-family: sans-serif; 
            background: #f0f2f5; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
        }
        /* –ö–∞–º–µ—Ä–∞–∏ —Ö—É—Ä–¥ - 30% —ç–∫—Ä–∞–Ω */
        #reader { 
            width: 100% !important; 
            height: 30vh !important; 
            background: #000;
        }
        /* –†”Ø–π—Ö–∞—Ç–∏ –º–æ–ª“≥–æ - 70% —ç–∫—Ä–∞–Ω */
        #product-list { 
            flex: 1;
            background: white; 
            border-radius: 20px 20px 0 0; 
            padding: 15px; 
            overflow-y: auto; 
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            margin-top: -10px;
            z-index: 10;
        }
        .item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px; margin-bottom: 10px; 
            background: #fff; border: 1px solid #eee; border-radius: 12px;
        }
        .controls { display: flex; align-items: center; gap: 15px; }
        .btn-count { 
            width: 35px; height: 35px; border-radius: 10px; border: none; 
            background: #0088cc; color: white; font-size: 20px; font-weight: bold;
        }
        .count-val { font-size: 18px; font-weight: bold; min-width: 25px; text-align: center; }
        .confirm-btn { 
            position: fixed; bottom: 20px; right: 20px; 
            width: 60px; height: 60px; 
            background: #28a745; color: white; border: none; border-radius: 50%; 
            font-size: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
            display: flex; align-items: center; justify-content: center; z-index: 100;
        }
    </style>
</head>
<body>

<div id="reader"></div>

<div id="product-list">
    <h3 style="margin-top: 0; font-size: 18px;">üõí –°–∞–±–∞—Ç–∏ —Ñ—É—Ä”Ø—à:</h3>
    <div id="items"></div>
</div>

<button class="confirm-btn" onclick="finishSale()">‚úÖ</button>

<script>
    let tg = window.Telegram.WebApp;
    tg.expand();
    let cart = {}; 

    const html5QrCode = new Html5Qrcode("reader");
    
    // –¢–∞–Ω–∑–∏–º–æ—Ç–∏ –∫–∞–º–µ—Ä–∞ –±–∞—Ä–æ–∏ –æ–Ω –∫–∏ —Ö—É—Ä–¥ –±–æ—à–∞–¥
    html5QrCode.start(
        { facingMode: "environment" }, 
        { fps: 10, qrbox: { width: 200, height: 120 } }, 
        (decodedText) => {
            addItem(decodedText);
        }
    ).catch(err => {
        console.error("–•–∞—Ç–æ–≥–∏–∏ –∫–∞–º–µ—Ä–∞:", err);
    });

    function addItem(code) {
        // –ê–≥–∞—Ä –º–æ–ª –∞–ª–ª–∞–∫–∞–π –±–æ—à–∞–¥, —Ç–∞–Ω“≥–æ –º–∏“õ–¥–æ—Ä–∞—à—Ä–æ –∑–∏—ë–¥ –º–µ–∫—É–Ω–µ–º
        if (cart[code]) {
            cart[code] += 1;
        } else {
            cart[code] = 1;
            if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
        }
        renderCart();
    }

    function updateCount(code, delta) {
        cart[code] += delta;
        if (cart[code] <= 0) delete cart[code];
        renderCart();
    }

    function renderCart() {
        const container = document.getElementById('items');
        container.innerHTML = '';
        
        // –ù–∏—à–æ–Ω –¥–æ–¥–∞–Ω–∏ –º–æ–ª“≥–æ (–º–æ–ª“≥–æ–∏ –Ω–∞–≤ –¥–∞—Ä –±–æ–ª–æ)
        for (const [code, count] of Object.entries(cart)) {
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `
                <div>
                    <div style="font-weight: bold;">üì¶ –ö–æ–¥: ${code}</div>
                </div>
                <div class="controls">
                    <button class="btn-count" onclick="updateCount('${code}', -1)">‚àí</button>
                    <span class="count-val">${count}</span>
                    <button class="btn-count" onclick="updateCount('${code}', 1)">+</button>
                </div>
            `;
            container.prepend(div);
        }
    }

    function finishSale() {
        if (Object.keys(cart).length === 0) return;
        tg.sendData(JSON.stringify(cart));
        tg.close();
    }
</script>

</body>
</html>

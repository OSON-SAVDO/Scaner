import telebot
from telebot import types
import sqlite3

# –¢–û–ö–ï–ù–ò –•–£–î–†–û –ò–ù“∂–û –ì–£–ó–û–†–ï–î
TOKEN = '7888882227:AAESOj6D5oaWKHykmOiJpC0kGpeImJMIRC4'
bot = telebot.TeleBot(TOKEN)

# --- –ë–ê–ó–ê–ò –ú–ê–™–õ–£–ú–û–¢ ---
def init_db():
    conn = sqlite3.connect('sklad.db')
    cursor = conn.cursor()
    # “∂–∞–¥–≤–∞–ª –±–∞—Ä–æ–∏ –º–æ–ª“≥–æ
    cursor.execute('''CREATE TABLE IF NOT EXISTS products 
                      (barcode TEXT PRIMARY KEY, name TEXT, price REAL)''')
    # “∂–∞–¥–≤–∞–ª –±–∞—Ä–æ–∏ —Ñ—É—Ä”Ø—à
    cursor.execute('''CREATE TABLE IF NOT EXISTS sales 
                      (id INTEGER PRIMARY KEY AUTOINCREMENT, info TEXT, total REAL)''')
    conn.commit()
    conn.close()

# --- –¢–£–ì–ú–ê“≤–û ---
def main_menu():
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    btn1 = types.KeyboardButton("üì∑ –°–∫–∞–Ω–µ—Ä (–§—É—Ä”Ø—à)")
    btn2 = types.KeyboardButton("üì• “ö–∞–±—É–ª–∏ –±–æ—Ä (Excel)")
    btn3 = types.KeyboardButton("üìä “≤–∏—Å–æ–±–æ—Ç")
    markup.add(btn1)
    markup.add(btn2, btn3)
    return markup

@bot.message_handler(commands=['start'])
def welcome(message):
    init_db()
    bot.send_message(message.chat.id, "–•—É—à –æ–º–∞–¥–µ–¥! –ò–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥:", reply_markup=main_menu())

# --- “ö–ê–ë–£–õ–ò –ë–û–† ---
@bot.message_handler(func=lambda message: message.text == "üì• “ö–∞–±—É–ª–∏ –±–æ—Ä (Excel)")
def ask_excel(message):
    bot.send_message(message.chat.id, "–õ—É—Ç—Ñ–∞–Ω –º–∞—ä–ª—É–º–æ—Ç–∏ –º–æ–ª—Ä–æ –±–∞ —Ç–∞–≤—Ä–∏ –∑–µ—Ä–∏–Ω —Ñ–∏—Ä–∏—Å—Ç–µ–¥:\n–®—Ç—Ä–∏—Ö–∫–æ–¥ –ù–æ–º –ù–∞—Ä—Ö\n\n–ú–∞—Å–∞–ª–∞–Ω:\n1234567 –û—Ä–¥ 50")

# –ò–Ω “∑–æ –º–æ “õ–∞–±—É–ª–∏ –º–∞—ä–ª—É–º–æ—Ç–∏ –æ–¥–¥–∏—Ä–æ –º–µ—Å–æ–∑–µ–º (—á—É–Ω–∫–∏ Excel –¥–∞—Ä —Ç–µ–ª–µ—Ñ–æ–Ω –¥—É—à–≤–æ—Ä –∞—Å—Ç)
@bot.message_handler(func=lambda message: len(message.text.split()) == 3)
def add_product(message):
    try:
        data = message.text.split()
        barcode, name, price = data[0], data[1], float(data[2])
        
        conn = sqlite3.connect('sklad.db')
        cursor = conn.cursor()
        cursor.execute("INSERT OR REPLACE INTO products VALUES (?, ?, ?)", (barcode, name, price))
        conn.commit()
        conn.close()
        
        bot.send_message(message.chat.id, f"‚úÖ –ú–æ–ª –∏–ª–æ–≤–∞ —à—É–¥: {name} - {price} —Å–æ–º–æ–Ω”£")
    except:
        bot.send_message(message.chat.id, "‚ùå –•–∞—Ç–æ–≥”£ –¥–∞—Ä —Ñ–æ—Ä–º–∞—Ç. –ë–æ—è–¥: –ö–æ–¥ –ù–æ–º –ù–∞—Ä—Ö")

# –ó–∞—Ö–∏—Ä–∞–∏ –∫–æ—Ä
if __name__ == "__main__":
    print("–ë–æ—Ç —Ñ–∞—ä–æ–ª –∞—Å—Ç...")
    bot.polling(none_stop=True)
